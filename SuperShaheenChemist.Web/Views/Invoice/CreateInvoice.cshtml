<script src="https://code.jquery.com/ui/1.12.1/jquery-ui.js"></script>
<script src="https://code.jquery.com/ui/1.12.1/themes/start/jquery-ui.css"></script>
@{
    ViewBag.Title = "Create Invoice";
}
<div class="container">

    <div class="row mt-3">
        <div class="col-md-12">
            <h3>
                <i class="fa fa-globe"></i> Invoice No # 01
            </h3>
        </div>
    </div>
    <div class="row">
        <div class="col-md-12">
            <label><i class="fa fa-barcode" aria-hidden="true"></i> SCAN BARCODE OR SEARCH ITEMS</label>
        </div>
    </div>
    <div class="row">
        <div class="col-md-6">
            <div class="form-group">
                <label><i class="fa fa-search" aria-hidden="true"></i> <b>SEARCH ITEMS TO RETURN :</b></label>
                <input type="text" id="searchProduct" placeholder="Search Product By Name Or BarCode" class="form-control clearable" />
                <small>Search through product name or Barcode </small> <br />
            </div>
        </div>
        <div class="col-md-6">

        </div>
    </div>
    <div class="row">
        <div class="col-md-12">
            <div class="table-responsive">
                <table class="table" id="purchaseItems">
                    <thead class="">
                        <tr>
                            <th>Action</th>
                            <th>Item</th>
                            <th>Batch No</th>
                            <th>Price</th>
                            <th>Qty</th>
                            <th>Expiry</th>
                            <th>Disc %</th>
                            <th>Tax</th>
                            <th>Amount</th>
                        </tr>
                    </thead>
                    <tbody id="items">
                    </tbody>
                </table>
            </div>
        </div>
    </div>
</div>
<script>
    $(document).ready(function () {
        $('#searchProduct').autocomplete({
            source: function (request, response) {

                $.ajax({
                    url: "/purchase/GetProductList",
                    type: "GET",
                    dataType: 'JSON',
                    selectFirst: true,
                    data: { productName: request.term },
                    success: function (data) {
                        response($.map(data, function (item) {
                            return { label: item.ProductName, value: item.productID }
                        }));
                    }

                });
            },
            select: function (event, ui) {
                event.preventDefault();
                $('#searchProduct').val('');
                $product_id = ui.item.value;
                addRecordToTable($product_id);
                //$('#submit').show();
            },
            focus: function (event, ui) {
                return false;
            }
        });
        var dropdowndata;
        function addRecordToTable(productid) {
            $.ajax({
                url: "/purchase/getProduct",
                type: "GET",
                dataType: 'JSON',
                data: { productId: productid },
                success: function (data) {
                    Pname = data.ProductName;
                    
                    $.ajax({
                        async: false,
                        type: "GET",
                        url: "/invoice/ProductsWithBatchNo",
                        data: { Pname: Pname },
                        success: function (data) {
                            dropdowndata = data;
                            
                        }
                    });
                    var date = new Date(parseInt(data.ExpiryDate.substr(6)));
                    date = date.toLocaleDateString();
                    var start = "<select id='dropdown'>";
                    var close = "</select>";
                    var pattern="";
                    $.each(dropdowndata, function (i, data) {
                        
                        
                        pattern=pattern+"<option value=" + data.Id + ">" + data.BatchNo + "</option>";
                    });
                    var string = start + pattern + close;
                    $("#purchaseItems").append('<tr class="rowSelector" style="background-color: white;"><td><button class="remove btn btn-danger"><i class="fa fa-trash bill-times-icon" aria-hidden="true"></i></button></td><td>' + data.ProductName + '</td><td>' + string + '</td><td>'
                        + data.PackCost + '</td><td><input class="qunatity" name="text1" type="number"/></td><td>' + date + '</td><td><input class="discount" name="discount" type="number"/></td><td><input class="tax" type="number"/></td><td id="amount">0</td><td><input type="hidden" class="prodId" value="' + data.Id + '"></td></tr>');
                    $("#barcode_scan_area").empty();
                }
            });
        }
        $('#purchaseItems').on('keyup', 'input[name="text1"]', function () {
            var parentElement = $(this).closest("tr");
            var price = parentElement.find('td:eq(3)').text();
            var quantity = parentElement.find('input[name="text1"]').val();
            var amount = price * quantity;
            if (parentElement.find('input[name="discount"]').val() != "") {
                    if (parentElement.find('input[name="discount"]').val() > 10) {
                        parentElement.find('input[name="discount"]').val(10);
                    }
                    var discount = parentElement.find('input[name="discount"]').val();
                    discount = amount * (discount / 100);
                    amount = amount - discount;
            }
            parentElement.find('td:eq(8)').html(amount);
            
        });
        $('#purchaseItems').on('keyup', 'input[name="discount"]', function () {
            var parentElement = $(this).closest("tr");
            var price = parentElement.find('td:eq(3)').text();
            var quantity = parentElement.find('input[name="text1"]').val();
            var amount = price * quantity;
            if (parentElement.find('input[name="text1"]').val() != "") {
                if (parentElement.find('input[name="discount"]').val() > 10) {
                    parentElement.find('input[name="discount"]').val(10);
                }
                var discount = parentElement.find('input[name="discount"]').val();
                discount = amount * (discount/100);
                amount = amount - discount;
            }
            parentElement.find('td:eq(8)').html(amount);

        });
    }
    );
</script>
